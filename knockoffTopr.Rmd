---
title: "KnockoffTopr"
author: "Xu Zhihao"
date: "1/2/2020"
output: pdf_document
---


```{r}
library(tcltk2)
library(MASS)
f = function(x){
  return(dnorm(x,mean=0,sd=1))
}
g = function(x,muw=0.5){
  return(dnorm(x,mean=muw,sd=1))
}

# index: the affected censor, K: the number of all the censors
generateN = function(mu,Sigma=0){
  if (length(Sigma)==1){
    column = rnorm(length(mu),mean=mu,sd=1)
  } else {
    column = mvrnorm(n=1,mu=mu,Sigma=Sigma)
  }
  return(column)
}

# n = number of infected censor, K = Number of Censor
simulate_topr = function(n,mug=0.5,muw=0.5,Sigma=0,r=10,a=46.55,N=100){
  mu = c(rep(mug,n),rep(0,N-n))
  W = rep(0,N)
  m = 0
  data = c()
  allW = c()
  
  while (TRUE) {
    m = m + 1
    data=cbind(data,generateN(mu,Sigma))
    
    W = W + log(g(data[,m],muw = muw)/f(data[,m]))
    W = ifelse(W>0,W,0)
    allW = cbind(allW,W)
    
    s = sort(W,decreasing = TRUE,index.return =TRUE)
    w = s$x[1:r]
    r.index = s$ix[1:r]
    
    t = sum(w)
    if (t > a){
      break
    }
  }
  # data: the whole dataset, n: stopping time, 
  # W: the vector of all the W statistic, r.index: selected index
  result <- list(data=data,StopT=m,W=W,allW=allW,r.index = r.index,sig=n,mug=mug,muw=muw,N=N,r=r,a=a)
  return(result)
}

# t = Stopping time T, K = Number of censor
simulate_topr_Dummy = function(topr,mu,Sigma=0,r=10,a=46.55){
  W = rep(0,topr$N)
  if (length(Sigma)==1){
    data = matrix(generateN(rep(mu,topr$StopT),Sigma=0),nrow=topr$N,byrow=FALSE)
  } else {
    # Sigmak = Sigma - (Sigma - diag(s)) %*% solve(Sigma) %*% (Sigma - diag(s))
    data = c()
    for (j in 1:topr$StopT){
      muk = (Sigma - diag(s))%*%solve(Sigma)%*%topr$data[,j]
      data = cbind(data,generateN(mu=muk,Sigma=Sigmak))
    }
  }
  
  for (i in 1:topr$StopT){
    
    W = W + log(g(data[,i],muw=topr$muw)/f(data[,i]))
    W = ifelse(W>0,W,0)
  
    s = sort(c(W,topr$allW[,i]),decreasing = TRUE,index.return =TRUE)
    w = s$x[1:r]
    if (sum(w)>a){
      break
    }
  }
  result <- list(data=data[,1:i],W=W,t0=i)
  return(result)
}
```



```{r}
library(Smisc)
knockoff1 = function(topr,mu,Sigma=0,alpha=0.2){
  mu=rep(0,topr$N)
  null = simulate_topr_Dummy(topr,mu=mu,Sigma=Sigma,r=topr$r,a=topr$a)
  
  # W = topr$allW[,null$t0] - null$W
  # W = apply(topr$data[,1:null$t0],1,mean) - apply(null$data,1,mean)
  W = apply(topr$data[,1:null$t0],1,cusum,k=0,h=1000)[null$t0,] - apply(null$data,1,cusum,k=0,h=1000)[null$t0,]
  
  t0 = c(sort(abs(W)),1000)
  for (t in t0){
    Sp = sum(W >= t)
    Sm = sum(W <= -t)
    FDRhat = (1+Sm)/max(1,Sp)
    # print(FDRhat)
    if (FDRhat <= alpha){
      break
    }
  }
  t
  rej = which(W >= t)
  return(rej)
}
```

## Correlated

```{r}
library(tcltk2)
rho = 0.8;N=250
Sigma = matrix(rep(rho,N*N),N)
diag(Sigma) = 1
s = rep(min(c(2*min(eigen(Sigma)$values),1)),N)
Sigmak = Sigma - (Sigma - diag(s)) %*% solve(Sigma) %*% (Sigma - diag(s))

FDR = c()
POWER = c()
POWERtopr = c()
FDRtopr = c()
sig = 10

pb <- tkProgressBar("进度","已完成 %", 0, 100)
size=100
for (k in 1:size){
  topr = simulate_topr(n=sig,mug=0.5,muw=0.5,Sigma=Sigma,N=250,r=10,a=46.55)
  
  rej = knockoff1(topr,Sigma = Sigma,alpha=0.2)
  FDR = c(FDR,sum(rej %in% seq(1:sig)==FALSE)/length(rej))
  POWER = c(POWER,sum(rej %in% seq(1:sig))/length(seq(1:sig)))
  
  fdrTopr = sum((topr$r.index %in% 0:sig)==FALSE)/length(topr$r.index)
  powerTopr = sum(topr$r.index %in% 0:sig)/sig
  FDRtopr = c(FDRtopr,fdrTopr)
  POWERtopr = c(POWERtopr,powerTopr)
  
  info<- sprintf("已完成 %d%%", round(k*100/size))
  setTkProgressBar(pb, k*100/size, sprintf("进度 (%s)", info),info)
}
close(pb)
```


```{r}
cat("Topr:\n")
FDRtopr[is.nan(FDRtopr)] = 0
mean(FDRtopr)
mean(POWERtopr)
cat("Knockoff:\n")
FDR[is.nan(FDR)] = 0
mean(FDR)
mean(POWER)
```


## Independent

```{r}
FDR = c()
POWER = c()
POWERtopr = c()
FDRtopr = c()
sig = 15

pb <- tkProgressBar("进度","已完成 %", 0, 100)
size=1000
for (k in 1:size){
  topr = simulate_topr(n=sig,mug=1.5,muw=0.5,Sigma=0,N=250,r=10,a=46.55)
  rej = knockoff1(topr,alpha=0.2)
  FDR = c(FDR,sum(rej %in% seq(0:sig)==FALSE)/length(rej))
  POWER = c(POWER,sum(rej %in% seq(0:sig))/sig)
  
  fdrTopr = sum((topr$r.index %in% 0:sig)==FALSE)/length(topr$r.index)
  powerTopr = sum(topr$r.index %in% 0:sig)/sig
  FDRtopr = c(FDRtopr,fdrTopr)
  POWERtopr = c(POWERtopr,powerTopr)
  
  info<- sprintf("已完成 %d%%", round(k*100/size))
  setTkProgressBar(pb, k*100/size, sprintf("进度 (%s)", info),info)
}
close(pb)
```


```{r}
cat("Topr:\n")
FDRtopr[is.nan(FDRtopr)] = 0
mean(FDRtopr)
mean(POWERtopr)
cat("Knockoff:\n")
FDR[is.nan(FDR)] = 0
mean(FDR)
mean(POWER)
```

















